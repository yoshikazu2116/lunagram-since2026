import React, { useState, useEffect } from 'react';
import { Sparkles, Moon, Sun, Droplet, BookOpen, Star, Calendar, Info, Wind, Edit3, X, Save, RotateCcw, Trash2, FileText } from 'lucide-react';

// サンプルデータ（形式確認用）
const SAMPLE_DATA = {
  "名前": "テスト四郎",
  "生年月日": "2018年2月8日（平成30年）",
  "ソウルベース": "A(アマテラス)",
  "運命数": "08＋",
  "宿命月": "老月",
  "宿命月ページ": "初級編132ページ",
  "宿命数ページ": "初級編136ページ",
  "運命月": "満月",
  "color": "若葉色",
  "陰陽五行": "金－",
  "オイル一覧": [
    "ティートリー",
    "ユーカリ",
    "サイプレス"
  ],
  "運命サイクル": [
    "2017年【下弦＜忍耐＞】急変",
    "2018年【下弦＜忍耐＞】耐える",
    "2019年【下弦＜忍耐＞】清算",
    "2020年【新月＜努力＞】スタート",
    "2021年【新月＜努力＞】努力",
    "2022年【新月＜努力＞】決定",
    "2023年【上弦＜波乱＞】誘惑",
    "2024年【上弦＜波乱＞】希望",
    "2025年【上弦＜波乱＞】油断",
    "2026年【満月＜実り＞】ご縁（★現在地）",
    "2027年【満月＜実り＞】お金・力",
    "2028年【満月＜実り＞】動揺"
  ]
};

// 初期データ（空のテンプレート）
const EMPTY_DATA = {
  "名前": "",
  "生年月日": "",
  "ソウルベース": "",
  "運命数": "",
  "宿命月": "",
  "宿命月ページ": "",
  "宿命数ページ": "",
  "運命月": "",
  "color": "",
  "陰陽五行": "",
  "オイル一覧": [],
  "運命サイクル": []
};

// 色の定義
const COLOR_MAP = {
  "若葉色": "#B9D08B",
};

// カードコンポーネント（ホワイト・グラスモーフィズム）
const GlassCard = ({ children, className = "", highlight = false }) => (
  <div className={`
    backdrop-blur-xl
    border border-white/60
    rounded-2xl p-6 
    shadow-[0_8px_30px_rgb(0,0,0,0.04)]
    transition-all duration-300
    ${highlight 
      ? 'bg-gradient-to-br from-amber-50/80 to-indigo-50/80 border-amber-200/60 shadow-amber-100/50' 
      : 'bg-white/40 hover:bg-white/60'
    }
    ${className}
  `}>
    {children}
  </div>
);

// セクションタイトル
const SectionTitle = ({ icon: Icon, title }) => (
  <div className="flex items-center gap-2 mb-4 text-slate-600 border-b border-slate-200/50 pb-2">
    <Icon className="w-5 h-5 text-indigo-400" />
    <h3 className="font-serif text-lg tracking-wider font-semibold">{title}</h3>
  </div>
);

// 運命サイクルの解析ヘルパー
const parseCycleItem = (itemStr) => {
  if (!itemStr) return { year: "", phase: "", keyword: "", isCurrent: false };
  
  const isCurrent = itemStr.includes("★");
  const yearMatch = itemStr.match(/^(\d+年)/);
  const phaseMatch = itemStr.match(/【(.*?)】/);
  const keywordPart = itemStr.split(/】/)[1] || "";
  
  const year = yearMatch ? yearMatch[1] : "";
  const phase = phaseMatch ? phaseMatch[1] : "";
  let keyword = keywordPart.replace(/（★.*?）/, "").trim();
  
  return { year, phase, keyword, isCurrent, original: itemStr };
};

export default function App() {
  const [mounted, setMounted] = useState(false);
  const [profileData, setProfileData] = useState(EMPTY_DATA); // 初期状態を空に設定
  const [isEditing, setIsEditing] = useState(false);
  const [editValue, setEditValue] = useState("");
  const [errorMsg, setErrorMsg] = useState("");
  const [confirmMode, setConfirmMode] = useState(null); // 'reset', 'clear', 'sample'

  useEffect(() => {
    setMounted(true);
  }, []);

  // 編集モード開始
  const startEditing = () => {
    // データが初期状態（空テンプレート）の場合は、テキストエリアを空にする
    if (JSON.stringify(profileData) === JSON.stringify(EMPTY_DATA)) {
      setEditValue("");
    } else {
      setEditValue(JSON.stringify(profileData, null, 2));
    }
    setErrorMsg("");
    setConfirmMode(null);
    setIsEditing(true);
  };

  // 保存処理
  const handleSave = () => {
    try {
      // 空欄の場合は空データとして保存
      if (!editValue.trim()) {
        const freshData = JSON.parse(JSON.stringify(EMPTY_DATA));
        setProfileData(freshData);
      } else {
        const parsed = JSON.parse(editValue);
        setProfileData(parsed);
      }
      setIsEditing(false);
    } catch (e) {
      setErrorMsg("データの形式が正しくありません。カンマや括弧を確認してください。");
    }
  };

  // リセット実行（空のテンプレートに戻す）
  const executeReset = () => {
    const freshData = JSON.parse(JSON.stringify(EMPTY_DATA));
    setProfileData(freshData);
    setEditValue(""); // リセット時も入力欄は空にする
    setConfirmMode(null);
    setErrorMsg("");
  };

  // クリア実行（完全に空にする）
  const executeClear = () => {
    // 画面のデータも即座にクリアする
    const freshData = JSON.parse(JSON.stringify(EMPTY_DATA));
    setProfileData(freshData);
    
    setEditValue("");
    setConfirmMode(null);
    setErrorMsg("");
  };

  // サンプル読込実行
  const executeSample = () => {
    const sample = JSON.parse(JSON.stringify(SAMPLE_DATA));
    setEditValue(JSON.stringify(sample, null, 2));
    setConfirmMode(null);
    setErrorMsg("");
  };

  return (
    <div className="min-h-screen bg-[#FDFBF7] text-slate-700 font-sans selection:bg-indigo-100">
      
      {/* 背景：月の光と雲 */}
      <div className="fixed inset-0 overflow-hidden pointer-events-none z-0">
         {/* 大きな月 */}
         <div className="absolute top-[-10%] right-[-5%] w-[500px] h-[500px] rounded-full bg-gradient-to-b from-indigo-100/40 to-transparent blur-3xl" />
         <div className="absolute top-[10%] left-[-10%] w-[600px] h-[600px] rounded-full bg-gradient-to-r from-amber-50/50 to-transparent blur-3xl" />
         
         {/* 星屑のテクスチャ */}
         <div className="absolute inset-0 opacity-40 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] mix-blend-multiply" />
      </div>

      {/* 編集ボタン */}
      <button 
        onClick={startEditing}
        className="fixed top-6 right-6 z-50 px-5 py-3 rounded-full bg-white/90 backdrop-blur-md shadow-[0_4px_20px_rgba(0,0,0,0.1)] border border-indigo-100 hover:scale-105 transition-all text-indigo-900 font-medium flex items-center gap-2 group hover:shadow-indigo-200/50"
      >
        <div className="bg-indigo-100 p-1.5 rounded-full group-hover:bg-indigo-200 transition-colors">
            <Edit3 className="w-4 h-4 text-indigo-600" />
        </div>
        <span>データを入力</span>
      </button>

      {/* 編集モーダル */}
      {isEditing && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm animate-in fade-in duration-200">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 flex-wrap gap-2">
              <h3 className="font-bold text-slate-700 flex items-center gap-2 mr-auto">
                <Edit3 className="w-4 h-4" /> データ編集
              </h3>
              
              <div className="flex gap-2 items-center">
                 {/* クリアボタン */}
                 {confirmMode === 'clear' ? (
                   <div className="flex items-center gap-2 bg-red-50 px-3 py-1 rounded-full animate-in fade-in slide-in-from-right-2 border border-red-100">
                     <span className="text-xs text-red-600 font-medium whitespace-nowrap">全消去？</span>
                     <button onClick={executeClear} className="px-2 py-0.5 bg-red-500 text-white text-xs rounded hover:bg-red-600 transition-colors">はい</button>
                     <button onClick={() => setConfirmMode(null)} className="px-2 py-0.5 text-slate-500 text-xs hover:bg-slate-200 rounded transition-colors">いいえ</button>
                   </div>
                 ) : (
                    <button onClick={() => { setConfirmMode('clear'); setErrorMsg(''); }} className="p-2 text-xs text-slate-400 hover:text-red-500 flex items-center gap-1 transition-colors group" title="内容を空にする">
                      <Trash2 className="w-4 h-4" /> <span className="hidden sm:inline">クリア</span>
                    </button>
                 )}

                 {/* サンプル読込ボタン */}
                 {confirmMode === 'sample' ? (
                   <div className="flex items-center gap-2 bg-indigo-50 px-3 py-1 rounded-full animate-in fade-in slide-in-from-right-2 border border-indigo-100">
                     <span className="text-xs text-indigo-600 font-medium whitespace-nowrap">サンプル読込？</span>
                     <button onClick={executeSample} className="px-2 py-0.5 bg-indigo-500 text-white text-xs rounded hover:bg-indigo-600 transition-colors">はい</button>
                     <button onClick={() => setConfirmMode(null)} className="px-2 py-0.5 text-slate-500 text-xs hover:bg-slate-200 rounded transition-colors">いいえ</button>
                   </div>
                 ) : (
                    <button onClick={() => { setConfirmMode('sample'); setErrorMsg(''); }} className="p-2 text-xs text-slate-400 hover:text-indigo-500 flex items-center gap-1 transition-colors group" title="サンプルデータを読み込む">
                      <FileText className="w-4 h-4" /> <span className="hidden sm:inline">サンプル</span>
                    </button>
                 )}

                 {/* リセットボタン */}
                 {confirmMode === 'reset' ? (
                   <div className="flex items-center gap-2 bg-slate-100 px-3 py-1 rounded-full animate-in fade-in slide-in-from-right-2 border border-slate-200">
                     <span className="text-xs text-slate-600 font-medium whitespace-nowrap">初期化？</span>
                     <button onClick={executeReset} className="px-2 py-0.5 bg-slate-500 text-white text-xs rounded hover:bg-slate-600 transition-colors">はい</button>
                     <button onClick={() => setConfirmMode(null)} className="px-2 py-0.5 text-slate-500 text-xs hover:bg-slate-200 rounded transition-colors">いいえ</button>
                   </div>
                 ) : (
                   <button onClick={() => { setConfirmMode('reset'); setErrorMsg(''); }} className="p-2 text-xs text-slate-400 hover:text-slate-600 flex items-center gap-1 transition-colors group" title="初期状態に戻す">
                      <RotateCcw className="w-4 h-4 group-hover:-rotate-180 transition-transform duration-500" /> <span className="hidden sm:inline">リセット</span>
                   </button>
                 )}
                 
                 <div className="h-4 w-[1px] bg-slate-200 mx-1"></div>

                 <button onClick={() => setIsEditing(false)} className="p-2 hover:bg-slate-200 rounded-full transition-colors">
                    <X className="w-5 h-5 text-slate-500" />
                 </button>
              </div>
            </div>
            
            <div className="p-4 flex-1 overflow-auto bg-slate-50 relative">
              <p className="text-xs text-slate-500 mb-2">
                ここにデータを貼り付けてください。
              </p>
              <textarea 
                className="w-full h-96 font-mono text-sm p-4 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-300 focus:border-indigo-300 outline-none shadow-inner bg-white text-slate-700 leading-relaxed"
                value={editValue}
                onChange={(e) => setEditValue(e.target.value)}
                placeholder="{ ... データを貼り付け ... }"
              />
              {errorMsg && (
                <div className="mt-2 text-red-500 text-sm flex items-center gap-2 bg-red-50 p-2 rounded">
                  <Info className="w-4 h-4" /> {errorMsg}
                </div>
              )}
            </div>

            <div className="p-4 border-t border-slate-100 bg-white flex justify-end gap-3">
              <button 
                onClick={() => setIsEditing(false)}
                className="px-4 py-2 rounded-lg text-slate-500 hover:bg-slate-100 transition-colors"
              >
                キャンセル
              </button>
              <button 
                onClick={handleSave}
                className="px-6 py-2 rounded-lg bg-indigo-600 text-white font-medium hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all flex items-center gap-2"
              >
                <Save className="w-4 h-4" /> 保存して反映
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* メインコンテンツ */}
      <div className={`relative z-10 max-w-5xl mx-auto p-4 md:p-8 transition-all duration-1000 ${mounted ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4'}`}>
        
        {/* ヘッダー */}
        <header className="text-center mb-12 pt-8 relative">
          <div className="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-10 w-32 h-32 bg-yellow-100 rounded-full blur-[60px] opacity-60 pointer-events-none"></div>
          
          <div className="inline-block relative">
             <div className="absolute inset-0 bg-yellow-200 rounded-full blur-xl opacity-20 animate-pulse"></div>
             <Moon className="w-12 h-12 text-slate-300 relative z-10 mb-4 mx-auto drop-shadow-lg" fill="#f1f5f9" strokeWidth={1} />
          </div>

          {/* アプリタイトル */}
          <div className="mb-8">
            <h1 className="text-2xl md:text-3xl font-serif font-bold text-indigo-950 tracking-widest mb-2">
              心理心月鑑定
            </h1>
            <div className="text-sm md:text-base font-light text-indigo-400 tracking-[0.3em] uppercase">
              ー LUNAGRAM ー
            </div>
          </div>

          {/* 名前 */}
          <div className="inline-block px-8 py-3 bg-white/40 backdrop-blur-sm rounded-full border border-white/60 shadow-sm mb-2 min-w-[200px] min-h-[60px]">
            <h2 className="text-2xl md:text-3xl font-serif font-bold text-slate-700 tracking-tight">
              {profileData["名前"] || "No Name"}
            </h2>
          </div>

          <div className="flex items-center justify-center gap-3 text-slate-500 font-light tracking-widest text-sm md:text-base mt-4 min-h-[24px]">
            {profileData["生年月日"] && (
              <>
                <span className="w-8 h-[1px] bg-slate-300"></span>
                <span>{profileData["生年月日"]} 生まれ</span>
                <span className="w-8 h-[1px] bg-slate-300"></span>
              </>
            )}
          </div>
        </header>

        <div className="grid grid-cols-1 md:grid-cols-12 gap-6">
          
          {/* 左カラム：基本ステータス */}
          <div className="md:col-span-4 space-y-6">
            <GlassCard className="text-center relative overflow-hidden group min-h-[140px]">
              <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-300 via-purple-300 to-amber-300"></div>
              <div className="text-xs text-indigo-400 uppercase tracking-widest mb-1 mt-2">Soul Base</div>
              <div className="text-4xl font-serif text-slate-700 mb-2">{profileData["ソウルベース"] || "-"}</div>
              <div className="text-xs text-slate-400 font-light">魂の基盤</div>
            </GlassCard>

            <GlassCard>
              <SectionTitle icon={Star} title="命式・属性" />
              <div className="space-y-4">
                <div className="flex justify-between items-center border-b border-slate-100 pb-3">
                  <span className="text-slate-400 text-sm font-light">運命数</span>
                  <span className="text-xl font-bold text-indigo-900 font-serif">{profileData["運命数"] || "-"}</span>
                </div>
                <div className="flex justify-between items-center border-b border-slate-100 pb-3">
                  <span className="text-slate-400 text-sm font-light">陰陽五行</span>
                  <span className="text-lg text-slate-700">{profileData["陰陽五行"] || "-"}</span>
                </div>
                <div className="flex justify-between items-center border-b border-slate-100 pb-3">
                  <span className="text-slate-400 text-sm font-light">運命月</span>
                  <span className="flex items-center gap-2 text-lg text-slate-700">
                    <Moon className="w-4 h-4 text-amber-400 fill-amber-100" />
                    {profileData["運命月"] || "-"}
                  </span>
                </div>
                <div className="flex justify-between items-center pt-1">
                  <span className="text-slate-400 text-sm font-light">ラッキーカラー</span>
                  <div className="flex items-center gap-2">
                    {profileData["color"] && (
                      <span 
                        className="w-5 h-5 rounded-full shadow-sm border border-slate-100"
                        style={{ backgroundColor: COLOR_MAP[profileData["color"]] || '#e2e8f0' }}
                      />
                    )}
                    <span className="text-slate-700">{profileData["color"] || "-"}</span>
                  </div>
                </div>
              </div>
            </GlassCard>

            <GlassCard>
              <SectionTitle icon={Droplet} title="オイル" />
              <div className="flex flex-wrap gap-2">
                {profileData["オイル一覧"] && profileData["オイル一覧"].length > 0 ? (
                  profileData["オイル一覧"].map((oil, idx) => (
                    <span key={idx} className="px-3 py-1.5 rounded-full bg-white border border-indigo-100 text-slate-600 text-sm flex items-center gap-1.5 shadow-sm">
                      <Wind className="w-3 h-3 text-indigo-300" />
                      {oil}
                    </span>
                  ))
                ) : (
                  <span className="text-slate-400 text-sm">-</span>
                )}
              </div>
            </GlassCard>

            <GlassCard>
              <SectionTitle icon={BookOpen} title="教科書ページ" />
              <div className="space-y-4 text-sm">
                <div className="flex items-start gap-3 p-2 rounded-lg hover:bg-slate-50 transition-colors">
                  <div className="p-1.5 bg-indigo-50 rounded-full text-indigo-400">
                    <Info className="w-4 h-4" />
                  </div>
                  <div>
                    <div className="text-slate-400 text-xs mb-0.5">宿命月ページ</div>
                    <div className="font-medium text-slate-700">{profileData["宿命月ページ"] || "-"}</div>
                  </div>
                </div>
                <div className="flex items-start gap-3 p-2 rounded-lg hover:bg-slate-50 transition-colors">
                  <div className="p-1.5 bg-indigo-50 rounded-full text-indigo-400">
                    <Info className="w-4 h-4" />
                  </div>
                  <div>
                    <div className="text-slate-400 text-xs mb-0.5">宿命数ページ</div>
                    <div className="font-medium text-slate-700">{profileData["宿命数ページ"] || "-"}</div>
                  </div>
                </div>
              </div>
            </GlassCard>
          </div>

          {/* 右カラム：運命サイクル */}
          <div className="md:col-span-8">
            <GlassCard className="h-full">
              <SectionTitle icon={Calendar} title="12年運命サイクル" />
              <div className="mt-6 space-y-2">
                {profileData["運命サイクル"] && profileData["運命サイクル"].length > 0 ? (
                  profileData["運命サイクル"].map((itemStr, index) => {
                    const { year, phase, keyword, isCurrent } = parseCycleItem(itemStr);
                    
                    return (
                      <div 
                        key={index}
                        className={`
                          relative flex items-center p-4 rounded-xl transition-all duration-300 group
                          ${isCurrent 
                            ? 'bg-gradient-to-r from-amber-50 to-indigo-50 border border-amber-200 shadow-md transform scale-[1.02] z-10 my-4' 
                            : 'bg-white/40 hover:bg-white/80 border border-transparent hover:border-indigo-100'
                          }
                        `}
                      >
                        {/* 現在地インジケーター */}
                        {isCurrent && (
                          <div className="absolute -left-1 top-1/2 -translate-y-1/2">
                             <div className="w-1 h-12 bg-amber-300 rounded-r-full shadow-[0_0_8px_#fcd34d]" />
                          </div>
                        )}

                        {/* 年 */}
                        <div className={`w-20 font-serif font-bold text-lg ${isCurrent ? 'text-amber-600' : 'text-slate-400'}`}>
                          {year}
                        </div>

                        {/* フェーズとキーワード */}
                        <div className="flex-1 flex flex-col md:flex-row md:items-center gap-1 md:gap-4">
                          <span className={`text-sm md:text-base ${isCurrent ? 'text-slate-700 font-semibold' : 'text-slate-500'}`}>
                            {phase}
                          </span>
                          
                          <div className={`hidden md:block h-1 w-1 rounded-full ${isCurrent ? 'bg-amber-300' : 'bg-slate-300'}`} />
                          
                          <span className={`text-base md:text-lg tracking-wide ${isCurrent ? 'text-indigo-900 font-bold' : 'text-slate-700'}`}>
                            {keyword}
                          </span>
                        </div>

                        {/* "現在地"バッジ */}
                        {isCurrent && (
                          <div className="hidden sm:flex items-center gap-1 px-3 py-1 rounded-full bg-white border border-amber-200 text-amber-600 text-xs font-bold shadow-sm">
                            <Star className="w-3 h-3 fill-amber-300 text-amber-400" />
                            現在地
                          </div>
                        )}
                      </div>
                    );
                  })
                ) : (
                  <div className="text-center py-12 text-slate-400">
                    <Calendar className="w-12 h-12 mx-auto mb-2 opacity-20" />
                    データがありません
                  </div>
                )}
              </div>
            </GlassCard>
          </div>
        </div>

        <footer className="mt-16 pb-8 text-center text-slate-400 text-xs flex flex-col items-center gap-2">
           <div className="w-8 h-[1px] bg-slate-300"></div>
           <p className="font-serif tracking-widest opacity-70">Spiritual Journey Map</p>
        </footer>
      </div>
    </div>
  );
}
